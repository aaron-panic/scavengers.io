<!-- admin_users.html - Admin panel subcontent styling
Copyright (C) 2026 Aaron Reichenbach

This program is free software: you can redistribute it and/or modify         
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.-->

{% extends 'admin.html' %}
{% import "components/table.html" as Table %}
{% import "components/modal.html" as Modal %}

{% block subcontent %}
    
    {# Render the Table #}
    {{ Table.render(columns, rows, classes=['table-data']) }}

    {# Render the Modal (if active) #}
    {% if modal_data %}
        
        {# Construct the Vertical Button Column for the Modal #}
        {% set user = modal_data.user %}
        
        {# Define current state variables for cleaner URLs #}
        {% set p_page = pagination.page %}
        {% set p_sort = pagination.sort %}
        {% set p_dir = pagination.dir %}

        {% set custom_content %}
            <div class="modal-actions-column">
                
                {# Password Reset (Always Available) #}
                <form action="{{ url_for('admin.reset_pass', user_id=user.id, page=p_page, sort=p_sort, dir=p_dir) }}" method="post" class="confirm-action" data-message="Reset password for {{ user.username }}?">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn full-width">Reset Password</button>
                </form>

                <div class="separator"></div>

                {# State-Specific Actions #}
                
                {# ACTIVE #}
                {% if user.status == 'active' %}
                    <form action="{{ url_for('admin.suspend_user', user_id=user.id, duration=24, page=p_page, sort=p_sort, dir=p_dir) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width">Suspend 24h</button>
                    </form>
                    <form action="{{ url_for('admin.suspend_user', user_id=user.id, duration=72, page=p_page, sort=p_sort, dir=p_dir) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width">Suspend 72h</button>
                    </form>
                    <form action="{{ url_for('admin.ban_user', user_id=user.id, page=p_page, sort=p_sort, dir=p_dir) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width destructive">Ban User</button>
                    </form>
                    
                    <div class="separator"></div> {# ADDED SPACER #}
                    
                    <form action="{{ url_for('admin.delete_user', user_id=user.id, page=p_page, sort=p_sort, dir=p_dir) }}" method="post" class="confirm-action" data-message="PERMANENTLY DELETE {{ user.username }}?">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width destructive">Delete User</button>
                    </form>
                
                {# SUSPENDED #}
                {% elif user.status == 'suspended' %}
                    <form action="{{ url_for('admin.reinstate_user', user_id=user.id, page=p_page, sort=p_sort, dir=p_dir) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width inverted">Reinstate</button>
                    </form>
                    <form action="{{ url_for('admin.ban_user', user_id=user.id, page=p_page, sort=p_sort, dir=p_dir) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width destructive">Ban User</button>
                    </form>

                    <div class="separator"></div> {# ADDED SPACER #}

                    <form action="{{ url_for('admin.delete_user', user_id=user.id, page=p_page, sort=p_sort, dir=p_dir) }}" method="post" class="confirm-action" data-message="PERMANENTLY DELETE {{ user.username }}?">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width destructive">Delete User</button>
                    </form>

                {# BANNED #}
                {% elif user.status == 'banned' %}
                    <form action="{{ url_for('admin.reinstate_user', user_id=user.id, page=p_page, sort=p_sort, dir=p_dir) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width inverted">Reinstate</button>
                    </form>
                    
                    <div class="separator"></div> {# ADDED SPACER #}

                    <form action="{{ url_for('admin.delete_user', user_id=user.id, page=p_page, sort=p_sort, dir=p_dir) }}" method="post" class="confirm-action" data-message="PERMANENTLY DELETE {{ user.username }}?">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn full-width destructive">Delete User</button>
                    </form>
                {% endif %}

            </div>
        {% endset %}

        {# Inject Content into Modal Data #}
        {% set _ = modal_data.update({'content': custom_content}) %}
        
        {{ Modal.render('user-modal', modal_data, classes=['open']) }}

    {% endif %}

    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}

{% block subcontent_footer %}
    <div class="panel-meta">
        [Records: {{ pagination.total_records }}]
        
        {% if pagination.has_prev %}
            <a href="{{ pagination.prev_href }}">[prev]</a>
        {% else %}
            <span class="text-muted">[prev]</span>
        {% endif %}

        {{ pagination.page }} / {{ pagination.pages }}

        {% if pagination.has_next %}
            <a href="{{ pagination.next_href }}">[next]</a>
        {% else %}
            <span class="text-muted">[next]</span>
        {% endif %}
    </div>
{% endblock %}