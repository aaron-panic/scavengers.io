<!-- admin_users.html - Admin panel subcontent for user management template
Copyright (C) 2026 Aaron Reichenbach

This program is free software: you can redistribute it and/or modify         
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.-->

{% extends 'admin.html' %}

{% macro sort_link(col_name, label) %}
    <a href="{{ url_for('admin.users', page=pagination.current_page, sort=col_name, dir='asc' if pagination.sort_col == col_name and pagination.sort_dir == 'desc' else 'desc') }}">
        {{ label }}
        {% if pagination.sort_col == col_name %}
            {{ '▲' if pagination.sort_dir == 'asc' else '▼' }}
        {% endif %}
    </a>
{% endmacro %}

{% block subcontent %}
    {# --- USER LIST VIEW --- #}
    <table class="table-data">
        <thead>
            <tr>
                <th id="col-id">{{ sort_link('id', 'id') }}</th>
                <th id="col-username">{{ sort_link('username', 'username') }}</th>
                <th id="col-role">{{ sort_link('role', 'role') }}</th>
                <th id="col-status">{{ sort_link('status', 'status') }}</th>
                <th id="col-actions" class="text-right">actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td title="{{ user.username }}">{{ user.username }}</td>
                <td>{{ user.role }}</td>
                <td class="status-{{ user.status }}">{{ user.status }}</td>
                <td class="text-right">
                    {% if user.status == 'requested' %}
                    <form action="{{ url_for('admin.approve', user_id=user.id) }}" method="post" class="form-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="link-button">[approve]</button>
                    </form>
                    <form action="{{ url_for('admin.deny', user_id=user.id) }}" method="post" class="form-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="link-button error-text">[deny]</button>
                    </form>
                    {% else %}
                    <a href="{{ url_for('admin.users', selected_user_id=user.id)}}">edit</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {# --- MODAL DETAIL VIEW --- #}
    {% if selected_user %}
    <div class="modal-backdrop">
        <article class="panel theme-panel modal">
            <header class="panel-header">
                <h3 class="panel-title">users/{{ selected_user.username }}</h3>
                <a href="{{ url_for('admin.users') }}">close</a>
            </header>

            <div class="panel-body">
                <div class="detail-row">
                    <strong>id:</strong> <span>{{ selected_user.id }}</span>
                </div>
                <div class="detail-row">
                    <strong>email:</strong> <span>{{ selected_user.email }}</span>
                </div>
                <div class="detail-row">
                    <strong>role:</strong> <span>{{ selected_user.role }}</span>
                </div>
                <div class="detail-row">
                    <strong>status:</strong> <span class="status-{{ selected_user.status }}">{{ selected_user.status }}</span>
                </div>
                {% if selected_user.suspended_until %}
                <div class="detail-row">
                    <strong>suspended Until:</strong> <span>{{ selected_user.suspended_until }}</span>
                </div>
                {% endif %}

                <div class="detail-actions">
                    <form action="{{ url_for('admin.reset_pass', user_id=selected_user.id) }}" method="post" class="confirm-action" data-message="Reset password for {{ selected_user.username }}?">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="form-button">pass reset</button>
                    </form>

                    {% if selected_user.status != 'suspended' and selected_user.status != 'banned' %}
                    <form action="{{ url_for('admin.suspend_user', user_id=selected_user.id, duration=24) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="form-button">suspend 24h</button>
                    </form>
                    <form action="{{ url_for('admin.suspend_user', user_id=selected_user.id, duration=72) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="form-button">suspend 72h</button>
                    </form>
                    {% endif %}

                    {% if selected_user.status != 'banned' %}
                    <form action="{{ url_for('admin.ban_user', user_id=selected_user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="form-button error-text">ban</button>
                    </form>
                    {% endif %}

                    {% if selected_user.status == 'banned' or selected_user.status == 'suspended' %}
                    <form action="{{ url_for('admin.reinstate_user', user_id=selected_user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="form-button">reinstate</button>
                    </form>
                    {% endif %}
                    
                     <form action="{{ url_for('admin.delete_user', user_id=selected_user.id) }}" method="post" class="confirm-action" data-message="DELETE USER {{ selected_user.username }}? This cannot be undone.">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="form-button error-text">delete</button>
                    </form>
                </div>
            </div>
        </article>
    </div>
    {% endif %}

    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}

{% block subcontent_footer %}
    <div class="panel-meta">
        [Records: {{ pagination.total_records }}]
        
        {% if pagination.current_page > 1 %}
            <a href="{{ url_for('admin.users', page=pagination.current_page - 1, sort=pagination.sort_col, dir=pagination.sort_dir) }}">[prev]</a>
        {% else %}
            <span class="text-muted">[prev]</span>
        {% endif %}

        {{ pagination.current_page }} / {{ pagination.total_pages }}

        {% if pagination.current_page < pagination.total_pages %}
            <a href="{{ url_for('admin.users', page=pagination.current_page + 1, sort=pagination.sort_col, dir=pagination.sort_dir) }}">[next]</a>
        {% else %}
            <span class="text-muted">[next]</span>
        {% endif %}
    </div>
{% endblock %}